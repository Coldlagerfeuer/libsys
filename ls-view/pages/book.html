<!DOCTYPE html>
<html lang="de">

<head>

<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta name="description" content="">
<meta name="author" content="">

<title>Libsys</title>

<!-- Bootstrap Core CSS -->
<link href="../vendor/bootstrap/css/bootstrap.min.css" rel="stylesheet">
<!-- MetisMenu CSS -->
<link href="../vendor/metisMenu/metisMenu.min.css" rel="stylesheet">
<!-- Custom CSS -->
<link href="../dist/css/sb-admin-2.css" rel="stylesheet">
<!-- Custom Fonts -->
<link href="../vendor/font-awesome/css/font-awesome.min.css"
	rel="stylesheet" type="text/css">


<link rel="stylesheet"
	href="//code.jquery.com/ui/1.12.1/themes/base/jquery-ui.css">

<!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
<!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
<!--[if lt IE 9]>
        <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
        <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
    <![endif]-->


<!-- jQuery -->
<script src="../vendor/jquery/jquery.min.js"></script>
<!-- Custom Theme JavaScript -->
<script src="../dist/js/sb-admin-2.js"></script>

<style type="text/css">


</style>

</head>

<body>
	<div id="wrapper">

		<!-- Navigation -->
		<div id="menu">
			<!-- Wird per Javascript geladen -->
		</div>


		<div id="page-wrapper">
			<div class="row" >
				<div id="alert-div" class="col-lg-9">
					<h1 id="book-title" class="page-header " contenteditable="false">Enter title</h1>
				
				</div>
				<div class="col-lg-3">
					<h1>
						<button id="btn-save" type="button" data-toggle="tooltip" data-placement="top" title="Save Book"
							class="hidden btn btn-success btn-circle btn-xl pull-center">
							<i class="fa fa-check"></i>
						</button>
						<button id="btn-delete" type="button" data-toggle="tooltip" data-placement="top" title="Delete Book"
							class="hidden btn btn-danger btn-circle btn-xl pull-center">
							<i class="fa fa-times"></i>
						</button>
						<button id="btn-edit" type="button"
							class="btn btn-default btn-circle btn-xl pull-right">
							<i class="fa fa-cog"></i>
						</button>
					</h1>
				</div>
				<!-- /.col-lg-12 -->
			</div>
			<!-- /.row -->

			<div class="row">
				<div class="col-md-3 " >
					<span class="lead">Category: </span>
					<span id="book-category" class="text-muted"></span>
					<select id="book-category-select" class="selectpicker form-control hidden" data-live-search="true">
						<!-- Filled by JS -->
					</select>
				</div>
				<div class=col-md-9>
					<small id="book-tags"></small>
				</div>
			</div>

			<div class="row">
				<div class="col-md-3">
					<div class="row">
						<div class="col-md-12">
						 	<div class="panel panel-default">
						 		<div class="panel-body">
									<!-- COVER -->
									<img  src="../img/placeholder-book.jpg" class="img-responsive" 
									alt="No image available" id="book-image"
									onerror="if (this.src != '../img/placeholder-book.jpg') this.src = '../img/placeholder-book.jpg';">
									</div>
							</div>
						</div>
					</div>
					<div class="row">
						<div class="col-md-12">
							<!-- AUTHOR -->
							<p id="book-author" class="text-muted">Enter Authors</p>
						</div>
					</div>
					<div class="row">
						<div class="col-md-12">
							<!-- Lent button -->
							<button id="book-btn-lent" type="button"
								class="btn btn-primary btn-lg btn-block">Lent book</button>
						</div>
					</div>
				</div>
				<div class="col-md-9">
				<div class="panel panel-default">
                        <!-- /.panel-heading -->
                        <div class="panel-body">
                            <!-- Nav tabs -->
                            <ul class="nav nav-pills">
                                <li class="active"><a href="#description-pills" data-toggle="tab">Description</a>
                                </li>
                                <li><a href="#bibtex-pills" data-toggle="tab">Bibtex</a>
                                </li>
                                <li><a href="#messages-pills" data-toggle="tab">Messages</a>
                                </li>
                                <li id="settings-pills-tab" class="hidden"><a href="#settings-pills" data-toggle="tab">Settings</a>
                                </li>
                            </ul>

                            <!-- Tab panes -->
                            <div class="tab-content">
                                <div class="tab-pane fade in active" id="description-pills">
                                    <h4></h4>
                                    <p id="book-description">No description available</p>
                                </div>
                                <div class="tab-pane fade" id="bibtex-pills">
                                    <h4>Bibtex String</h4>
                                    <p class="well" id="bibtex-entry" contenteditable="true">Could not generate bibtex entry</p>
                                </div>
                                <div class="tab-pane fade" id="messages-pills">
                                    <h4>Messages Tab</h4>
                                    <p>Lorem ipsum dolor sit amet, consectetur adipisicing elit, sed do eiusmod tempor incididunt ut labore et dolore magna aliqua. Ut enim ad minim veniam, quis nostrud exercitation ullamco laboris nisi ut aliquip ex ea commodo consequat. Duis aute irure dolor in reprehenderit in voluptate velit esse cillum dolore eu fugiat nulla pariatur. Excepteur sint occaecat cupidatat non proident, sunt in culpa qui officia deserunt mollit anim id est laborum.</p>
                                </div>
                                <div class="tab-pane fade" id="settings-pills">
                                    <h4>Settings Tab</h4>
                                    <div class="row">
                                    	<div class="col-md-2">
                                    		<p class="text-right">Publisher:</p>
                                    	</div>
                                    	<div class="col-md-10">
                                    		<input id="book-publisher" class="form-control">
                                    	</div>
                                    </div>
                                    <h4></h4>
                                    <div class="row">
                                    	<div class="col-md-2">
                                    		<p class="text-right">Year:</p>
                                    	</div>
                                    	<div class="col-md-10">
                                    		<input id="book-year" class="form-control">
                                    	</div>
                                    </div> 
                                </div>
                            </div>
                        </div>
                        <!-- /.panel-body -->
                    </div>
				
					<!-- <p id="book-description">
						No description available
					</p> -->
				</div>
			</div>
			<!-- /.row -->

			<!-- Modal -->
			<div id='modalPlaceholder'></div>

		</div>
		<!-- /#page-wrapper -->

	</div>
	<!-- /#wrapper -->

	<!-- jQuery -->
	<script src="https://code.jquery.com/ui/1.12.1/jquery-ui.js"></script>

	<!-- Bootstrap Core JavaScript -->
	<script src="../vendor/bootstrap/js/bootstrap.min.js"></script>

	<!-- Metis Menu Plugin JavaScript -->
	<script src="../vendor/metisMenu/metisMenu.min.js"></script>

	<script type="text/javascript">
		var book;	
		var currentModalId;
	
		$(document).ready(function() {
			// Fill Categories
			$.ajax({
				url: serverUrl + "categories/getAllCategories"
			}).then(function(data) {
 				for (var categoryId in data) {
 					var category = data[categoryId];
					$("#book-category-select").append('<option value="' + category.name + '">' + category.name + '</option>');
				} 
			});
			
			var bookname = getQueryVariable("name");
			var isbn = getQueryVariable("isbn");
			console.log("book: " + bookname);
			console.log("isbn: " + isbn);
			if (bookname != null || isbn != null) {
				var url = null;
				if (bookname != null) {
					url = serverUrl + "books/getByName?name=" + bookname;
				} else {
					url = serverUrl + "books/getByIsbn?isbn=" + isbn;
				}
				console.log("url: " + url);
				updateSiteWithUrl(url);
			} else {
				// Create new book
				$("#btn-edit").click();
				// Enter ISBN to start
				var modalId = "#modalIsbn"
				$('#modalPlaceholder').load('dialogs.html '+ modalId, function() {
					currentModalId = modalId;					
				    $(modalId).modal('toggle');
				});
				
				
			}
			
		}); // End document ready

		function processModalInput() {
		    $(currentModalId).modal('toggle');
		     var url = serverUrl + "books/getByIsbn?isbn=" + $('#message-text').val();
		     updateSiteWithUrl(url);
		}
		
		function updateSiteWithUrl(url) {
			$.ajax({
				url: url
			}).then(function(data) {
				console.log("Ajax: " + data);
				if (data != null) {
					book = JSON.parse(JSON.stringify(data)); // simple workaround for clone
					setBookFields(book);
					
					/* Search for image */
					// var imageurl = "http://covers.openlibrary.org/b/isbn/" + data.isbn + ".jpg";
					var imageurl = serverUrl + "books/getImageForIsbn?isbn=" + data.isbn;
					console.log("imageURL: " + imageurl);
					$("#book-image").attr("src", imageurl);
					
					// generate bibtex entry
					generateBibtexEntry();
					
				} else {
					console.log("No or multiple books found");
				}
			});
		}
		
		function generateBibtexEntry() {
			$.ajax({
				url: serverUrl + "books/getBibtexForBook?isbn=" + book.isbn
			}).then(function(data) {
				console.log("bibtex string: " + data);
				$('#bibtex-entry').html(data);
			});
		}
		
		$("#book-category-select").change(function() {
			$("#book-category").text($(this).val());
		});
		
		$(document).on('click', '#btn-delete', function() {
			console.log("Open delete modal");
			var modalId = "#modalDelete"
			$('#modalPlaceholder').load('dialogs.html '+ modalId , function() {
				currentModalId = modalId;
				/* $("#modalBookName").html("Bookname: \"" + book.name + "\""); */
			    $(modalId).modal('toggle');
			});
			
		});
		
		function processModalDelete() {
			$(currentModalId).modal('toggle');
			console.log("process delete")
			$.ajax({
				url: serverUrl + "books/delete?isbn=" + book.isbn,
				success: function (data) {
					console.log("ajax delete success");
					$("#alert-div").append(getSuccessAlertText("Successfully deleted book in database."));
				},
				error:function(e) {
					console.log("ajax delete failed");
					$("#alert-div").append(getErrorAlertText("Could not delete book."));
				}
			});
		}
		
 		$(document).on('focus', '#bibtex-entry', function(){
			document.execCommand('selectAll');
			document.execCommand("copy");
			$("#bibtex-pills").append(getSuccessAlertText("Copied bibtex entry to clipboard"));
			
		}); 
		
		$(document).on('click', '#btn-edit', function() {
			if (toggleEditDesignClasses() == false) {
				// Revert input
				setBookFields(book);
			}
		});
		
		$(document).on('click', '#btn-save', function() {
			console.log(book);
			if (book != null) {
				toggleEditDesignClasses();
				
				book.title = $("#book-title").text();
				book.description = $("#book-description").html();
				var authorsSplit = $("#book-author").html().split("<br>");
				book.authors = [];
				for (var i in authorsSplit) {
					author = authorsSplit[i];
					if (author != "") {
						book.authors.push(author);
					}
				}
				book.category.name = $("#book-category").text();
				book.publisher = $("#book-publisher").val();
				book.year = $("#book-year").val();
				
				console.log($("#book-author").text());
				console.log(book.authors);
				
				$.ajax({
					headers : {
					    'Accept' : 'application/json',
					    'Content-Type' : 'application/json'
					},
					type : 'POST',
					data : JSON.stringify(book),
					dataType : 'json',
					url: serverUrl + "books/update",
					success: function(data) {
						if (data == true) {
							console.log("update succesful");
							$("#alert-div").append(getSuccessAlertText("Successfully updated book in database."));
							
						} else {
							console.log("update failed, save new book");
							saveNewBook(book);
						}
					},
					error: function(e) {
						console.log(e);
					}
				});
			} else {
				console.log("No saved book found");
			}
		});

		function saveNewBook(book) {
			$.ajax({
				headers : {
				    'Accept' : 'application/json',
				    'Content-Type' : 'application/json'
				},
				type : 'POST',
				data : JSON.stringify(book),
				dataType : 'json',
				url: serverUrl + "books/saveNewBook",
				success: function(data) {
					console.log("Successfully saved book in database.");
					$("#alert-div").append(getSuccessAlertText("Successfully saved book in database."));
				}
			});
		}
		function getErrorAlertText(text) {
			setTimeout(function() {
			    $('.alert').fadeOut('slow');
			    }, 3000);
			return '<div id="error-alert" class="alert alert-danger alert-dismissable fade in">'
            + '<button type="button" class="close" data-dismiss="alert" aria-hidden="true">&times;</button>'
            + '<strong>Error!</strong> ' + text + '</div>';
		}
		
		function getSuccessAlertText(text) {
			setTimeout(function() {
			    $('.alert').fadeOut('slow');
			    }, 3000);
			return '<div id="success-alert" class="alert alert-success alert-dismissable fade in">'
            + '<button type="button" class="close" data-dismiss="alert" aria-hidden="true">&times;</button>'
            + '<strong>Success!</strong> ' + text + '</div>';
		}
		
		function toggleEditDesignClasses() {
			$("#btn-save").toggleClass("hidden");
			$("#btn-delete").toggleClass("hidden");
			$("#settings-pills-tab").toggleClass("hidden");
			if ($("#settings-pills-tab").hasClass("active")) {
				$('.nav-pills a[href="#description-pills"]').tab('show');
			}
			var editable = !$("#btn-save").hasClass("hidden"); 			
			$("#book-title").attr("contenteditable", editable);
			$("#book-description").attr("contenteditable", editable);
			$("#book-author").attr("contenteditable", editable);
			$("#book-tags").attr("contenteditable", editable);
						
			if (editable) {
				$("#book-title").addClass("well well-sm");
				$("#book-description").addClass("well well-sm");
				$("#book-author").addClass("well well-sm");
				$("#book-tags").addClass("well well-sm form-control");
				$("#book-category-select").removeClass("hidden");
			} else {
				// Remove design
				$("#book-title").removeClass("well well-sm");
				$("#book-description").removeClass("well well-sm");
				$("#book-author").removeClass("well well-sm");
				$("#book-tags").removeClass("well well-sm form-control");
				$("#book-category-select").addClass("hidden");
			}
			return editable;
		}
		
		function setBookFields(book) {
			console.log("Setting book fields");
			console.log(book);
			$("#book-title").text(book.name);
			var description = (book.description == "") ? "No description available" : book.description;
			$("#book-description").html(description);
			$("#book-author").html(getNameStringFromArray(book.authors, "<br>"));
			console.log("CATEGORY: " + book.category.name);
			$("#book-category").html('<a href=list-books.html?category=' + book.category.name +'>' + book.category.name + '</a>');
			$("#book-category-select").val(book.category.name);			
			// book.tags = ["tag1", "tag2", "tag3"]; Example values 
			var tagString = "";
			for(var i in book.tags) {
				var tag = book.tags[i];
				tagString +=  '<a href=list-books.html?tag=' + tag.name +'>' + tag.name + '</a>, ' ;
			}
			// Remove the last comma
			$("#book-tags").html(tagString.substring(0, tagString.length - 3));
			
			//Settings Tab
			$("#book-publisher").val(book.publisher);
			$("#book-year").val(book.year);
		}

	</script>


</body>

</html>
